

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Customizing Further a Regression Test &mdash; ReFrame 2.14 documentation</title>
  

  
  
    <link rel="shortcut icon" href="_static/favicon.png"/>
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/banner.css" type="text/css" />
    <link rel="author" title="About these documents" href="about.html" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Understanding the Mechanism of Sanity Functions" href="deferrables.html" />
    <link rel="prev" title="ReFrame Tutorial" href="tutorial.html" /> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          
    

          
            <a href="index.html" class="icon icon-home"> ReFrame
          

          
          </a>

          
            
            
              <div class="version">
                2.14
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          

        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
    
            
            
              
            
            
              <p class="caption"><span class="caption-text">Table of Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="configure.html">Configuring ReFrame For Your Site</a></li>
<li class="toctree-l1"><a class="reference internal" href="pipeline.html">The Regression Test Pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial.html">ReFrame Tutorial</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Customizing Further A Regression Test</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#working-with-makefiles">Working with Makefiles</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#retrieving-the-source-code-from-a-git-repository">Retrieving the source code from a Git repository</a></li>
<li class="toctree-l3"><a class="reference internal" href="#add-a-configuration-step-before-compiling-the-code">Add a configuration step before compiling the code</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#implementing-a-run-only-regression-test">Implementing a Run-Only Regression Test</a></li>
<li class="toctree-l2"><a class="reference internal" href="#implementing-a-compile-only-regression-test">Implementing a Compile-Only Regression Test</a></li>
<li class="toctree-l2"><a class="reference internal" href="#leveraging-environment-variables">Leveraging Environment Variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="#setting-a-time-limit-for-regression-tests">Setting a Time Limit for Regression Tests</a></li>
<li class="toctree-l2"><a class="reference internal" href="#applying-a-sanity-function-iteratively">Applying a sanity function iteratively</a></li>
<li class="toctree-l2"><a class="reference internal" href="#customizing-the-generated-job-script">Customizing the Generated Job Script</a></li>
<li class="toctree-l2"><a class="reference internal" href="#working-with-parameterized-tests">Working with parameterized tests</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="deferrables.html">Understanding The Mechanism Of Sanity Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="running.html">Running ReFrame</a></li>
<li class="toctree-l1"><a class="reference internal" href="usecases.html">Use cases</a></li>
<li class="toctree-l1"><a class="reference internal" href="about.html">About ReFrame</a></li>
<li class="toctree-l1"><a class="reference internal" href="reference.html">Reference Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="sanity_functions_reference.html">Sanity Functions Reference</a></li>
</ul>

            
          
    <hr>
    <p class="caption">
      <span class="caption-text">Useful Links</span>
    </p>
    <ul>
      <li class="toctree-l1"><a class="reference internal" href="https://github.com/eth-cscs/reframe" target="_blank">Get ReFrame</a></li>
      <li class="toctree-l1"><a class="reference internal" href="https://github.com/eth-cscs/production" target="_blank">CSCS Easybuild recipes</a></li>
      <li class="toctree-l1"><a class="reference internal" href="http://www.cscs.ch" target="_blank">CSCS</a></li>
      <li class="toctree-l1"><a class="reference internal" href="http://www.ethz.ch" target="_blank">ETH Zurich</a></li>
    </ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">ReFrame</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          <div role="navigation" aria-label="breadcrumbs navigation">
  <div style="text-align: center; margin-bottom: -1.5em; display: block"></div>
  <ul class="wy-breadcrumbs">
    <li><a href="index.html">Docs</a> &raquo;</li>
      
    <li>Customizing Further a Regression Test</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="https://github.com/eth-cscs/reframe" class="fa fa-github"> View on GitHub</a>
          
            <!-- <a href="https://eth-cscs.github.io/reframe">ReFrame</a> -->
            <!-- <a href="Section_commands.html#comm">Commands</a> -->
        
      </li>
  </ul>
  <hr/>
  
    <div class="rst-footer-buttons" style="margin-bottom: 1em" role="navigation" aria-label="footer navigation">
      
        <a href="deferrables.html" class="btn btn-neutral float-right" title="Understanding the Mechanism of Sanity Functions" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="tutorial.html" class="btn btn-neutral" title="ReFrame Tutorial" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="customizing-further-a-regression-test">
<h1>Customizing Further a Regression Test<a class="headerlink" href="#customizing-further-a-regression-test" title="Permalink to this headline">¶</a></h1>
<p>In this section, we are going to show some more elaborate use cases of ReFrame.
Through the use of more advanced examples, we will demonstrate further customization options which modify the default options of the ReFrame pipeline.
The corresponding scripts as well as the source code of the examples discussed here can be found in the directory <code class="docutils literal"><span class="pre">tutorial/advanced</span></code>.</p>
<div class="section" id="working-with-makefiles">
<h2>Working with Makefiles<a class="headerlink" href="#working-with-makefiles" title="Permalink to this headline">¶</a></h2>
<p>We have already shown how you can compile a single source file associated with your regression test.
In this example, we show how ReFrame can leverage Makefiles to build executables.</p>
<p>Compiling a regression test through a Makefile is straightforward with ReFrame.
If the <a class="reference internal" href="reference.html#reframe.core.pipeline.RegressionTest.sourcepath" title="reframe.core.pipeline.RegressionTest.sourcepath"><code class="xref py py-attr docutils literal"><span class="pre">sourcepath</span></code></a> attribute refers to a directory, then ReFrame will automatically invoke <code class="docutils literal"><span class="pre">make</span></code> in that directory.
More specifically, ReFrame first copies the <code class="xref py py-attr docutils literal"><span class="pre">sourcesdir</span></code> to the stage directory at the beginning of the compilation phase and then constructs the path <code class="docutils literal"><span class="pre">os.path.join('{STAGEDIR}',</span> <span class="pre">self.sourcepath)</span></code> to determine the actual compilation path.
If this is a directory, it will invoke <code class="docutils literal"><span class="pre">make</span></code> in it.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The <a class="reference internal" href="reference.html#reframe.core.pipeline.RegressionTest.sourcepath" title="reframe.core.pipeline.RegressionTest.sourcepath"><code class="xref py py-attr docutils literal"><span class="pre">sourcepath</span></code></a> attribute must be a relative path refering to a subdirectory of <a class="reference internal" href="reference.html#reframe.core.pipeline.RegressionTest.sourcesdir" title="reframe.core.pipeline.RegressionTest.sourcesdir"><code class="xref py py-attr docutils literal"><span class="pre">sourcesdir</span></code></a>, i.e., relative paths starting with <code class="docutils literal"><span class="pre">..</span></code> will be rejected.</p>
</div>
<p>By default, <a class="reference internal" href="reference.html#reframe.core.pipeline.RegressionTest.sourcepath" title="reframe.core.pipeline.RegressionTest.sourcepath"><code class="xref py py-attr docutils literal"><span class="pre">sourcepath</span></code></a> is the empty string and <a class="reference internal" href="reference.html#reframe.core.pipeline.RegressionTest.sourcesdir" title="reframe.core.pipeline.RegressionTest.sourcesdir"><code class="xref py py-attr docutils literal"><span class="pre">sourcesdir</span></code></a> is set to <code class="docutils literal"><span class="pre">'src/'</span></code>.
As a result, by not specifying a <a class="reference internal" href="reference.html#reframe.core.pipeline.RegressionTest.sourcepath" title="reframe.core.pipeline.RegressionTest.sourcepath"><code class="xref py py-attr docutils literal"><span class="pre">sourcepath</span></code></a> at all, ReFrame will eventually compile the files found in the <code class="docutils literal"><span class="pre">src/</span></code> directory.
This is exactly what our first example here does.</p>
<p>For completeness, here are the contents of <code class="docutils literal"><span class="pre">Makefile</span></code> provided:</p>
<div class="highlight-makefile"><div class="highlight"><pre><span></span><span class="nv">EXECUTABLE</span> <span class="o">:=</span> advanced_example1 

<span class="nf">.SUFFIXES</span><span class="o">:</span> .<span class="n">o</span> .<span class="n">c</span>

<span class="nv">OBJS</span> <span class="o">:=</span> advanced_example1.o

<span class="nf">$(EXECUTABLE)</span><span class="o">:</span> <span class="k">$(</span><span class="nv">OBJS</span><span class="k">)</span>
	<span class="k">$(</span>CC<span class="k">)</span> <span class="k">$(</span>CFLAGS<span class="k">)</span> <span class="k">$(</span>LDFLAGS<span class="k">)</span> -o <span class="nv">$@</span> $^
 
<span class="nf">$(OBJS)</span><span class="o">:</span> <span class="n">advanced_example</span>1.<span class="n">c</span>
	<span class="k">$(</span>CC<span class="k">)</span> <span class="k">$(</span>CPPFLAGS<span class="k">)</span> <span class="k">$(</span>CFLAGS<span class="k">)</span> -c <span class="k">$(</span>LDFLAGS<span class="k">)</span> -o <span class="nv">$@</span> $^ 
</pre></div>
</div>
<p>The corresponding <code class="docutils literal"><span class="pre">advanced_example1.c</span></code> source file consists of a simple printing of a message, whose content depends on the preprocessor variable <code class="docutils literal"><span class="pre">MESSAGE</span></code>:</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(){</span>
<span class="cp">#ifdef MESSAGE</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">message</span> <span class="o">=</span> <span class="s">&quot;SUCCESS&quot;</span><span class="p">;</span>
<span class="cp">#else</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">message</span> <span class="o">=</span> <span class="s">&quot;FAILURE&quot;</span><span class="p">;</span>
<span class="cp">#endif</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Setting of preprocessor variable: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">message</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The purpose of the regression test in this case is to set the preprocessor variable <code class="docutils literal"><span class="pre">MESSAGE</span></code> via <code class="docutils literal"><span class="pre">CPPFLAGS</span></code> and then check the standard output for the message <code class="docutils literal"><span class="pre">SUCCESS</span></code>, which indicates that the preprocessor flag has been passed and processed correctly by the Makefile.</p>
<p>The contents of this regression test are the following (<code class="docutils literal"><span class="pre">tutorial/advanced/advanced_example1.py</span></code>):</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">reframe</span> <span class="k">as</span> <span class="nn">rfm</span>
<span class="kn">import</span> <span class="nn">reframe.utility.sanity</span> <span class="k">as</span> <span class="nn">sn</span>


<span class="nd">@rfm</span><span class="o">.</span><span class="n">simple_test</span>
<span class="k">class</span> <span class="nc">MakefileTest</span><span class="p">(</span><span class="n">rfm</span><span class="o">.</span><span class="n">RegressionTest</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">descr</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;ReFrame tutorial demonstrating the use of Makefiles &#39;</span>
                      <span class="s1">&#39;and compile options&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">valid_systems</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">valid_prog_environs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executable</span> <span class="o">=</span> <span class="s1">&#39;./advanced_example1&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build_system</span> <span class="o">=</span> <span class="s1">&#39;Make&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build_system</span><span class="o">.</span><span class="n">cppflags</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;-DMESSAGE&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sanity_patterns</span> <span class="o">=</span> <span class="n">sn</span><span class="o">.</span><span class="n">assert_found</span><span class="p">(</span><span class="s1">&#39;SUCCESS&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maintainers</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;put-your-name-here&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tags</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tutorial&#39;</span><span class="p">}</span>
</pre></div>
</div>
<p>The important bit here is how we set up the build system for this test:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>    <span class="bp">self</span><span class="o">.</span><span class="n">build_system</span> <span class="o">=</span> <span class="s1">&#39;Make&#39;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">build_system</span><span class="o">.</span><span class="n">cppflags</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;-DMESSAGE&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p>First, we set the build system to <a class="reference internal" href="reference.html#reframe.core.buildsystems.Make" title="reframe.core.buildsystems.Make"><code class="xref py py-attr docutils literal"><span class="pre">Make</span></code></a> and then set the preprocessor flags for the compilation.
ReFrame will invoke <code class="docutils literal"><span class="pre">make</span></code> as follows:</p>
<div class="code highlight-default"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="o">-</span><span class="n">j</span> <span class="n">CC</span><span class="o">=</span><span class="s1">&#39;cc&#39;</span> <span class="n">CXX</span><span class="o">=</span><span class="s1">&#39;CC&#39;</span> <span class="n">FC</span><span class="o">=</span><span class="s1">&#39;ftn&#39;</span> <span class="n">NVCC</span><span class="o">=</span><span class="s1">&#39;nvcc&#39;</span> <span class="n">CPPFLAGS</span><span class="o">=</span><span class="s1">&#39;-DMESSAGE&#39;</span>
</pre></div>
</div>
<p>The compiler variables (<code class="docutils literal"><span class="pre">CC</span></code>, <code class="docutils literal"><span class="pre">CXX</span></code> etc.) are set based on the corresponding values specified in the <a class="reference external" href="configure.html#environments-configuration">coniguration of the current environment</a>.
You may instruct the build system to ignore the default values from the environment by setting the following:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">build_system</span><span class="o">.</span><span class="n">flags_from_environ</span> <span class="o">=</span> <span class="bp">False</span>
</pre></div>
</div>
<p>In this case, <code class="docutils literal"><span class="pre">make</span></code> will be invoked as follows:</p>
<div class="code highlight-default"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="o">-</span><span class="n">j</span> <span class="n">CPPFLAGS</span><span class="o">=</span><span class="s1">&#39;-DMESSAGE&#39;</span>
</pre></div>
</div>
<p>Notice that the <code class="docutils literal"><span class="pre">-j</span></code> option is always generated.
If you want to limit build concurrency, you can do it as follows:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">build_system</span><span class="o">.</span><span class="n">max_concurrency</span> <span class="o">=</span> <span class="mi">4</span>
</pre></div>
</div>
<p>Finally, you may also customize the name of the <code class="docutils literal"><span class="pre">Makefile</span></code>.
You can achieve that by setting the corresponding variable of the <a class="reference internal" href="reference.html#reframe.core.buildsystems.Make" title="reframe.core.buildsystems.Make"><code class="xref py py-class docutils literal"><span class="pre">Make</span></code></a> build system:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">build_system</span><span class="o">.</span><span class="n">makefile</span> <span class="o">=</span> <span class="s1">&#39;Makefile_custom&#39;</span>
</pre></div>
</div>
<p>More details on ReFrame’s build systems, you may find <a class="reference external" href="reference.html#build-systems">here</a>.</p>
<div class="section" id="retrieving-the-source-code-from-a-git-repository">
<h3>Retrieving the source code from a Git repository<a class="headerlink" href="#retrieving-the-source-code-from-a-git-repository" title="Permalink to this headline">¶</a></h3>
<p>It might be the case that a regression test needs to clone its source code from a remote repository.
This can be achieved in two ways with ReFrame.
One way is to set the <code class="xref py py-attr docutils literal"><span class="pre">sourcesdir</span></code> attribute to <code class="xref py py-class docutils literal"><span class="pre">None</span></code> and explicitly clone or checkout a repository using the <a class="reference internal" href="reference.html#reframe.core.pipeline.RegressionTest.prebuild_cmd" title="reframe.core.pipeline.RegressionTest.prebuild_cmd"><code class="xref py py-attr docutils literal"><span class="pre">prebuild_cmd</span></code></a>:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">sourcesdir</span> <span class="o">=</span> <span class="bp">None</span>
<span class="bp">self</span><span class="o">.</span><span class="n">prebuild_cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;git clone https://github.com/me/myrepo .&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p>By setting <code class="xref py py-attr docutils literal"><span class="pre">sourcesdir</span></code> to <code class="xref py py-class docutils literal"><span class="pre">None</span></code>, you are telling ReFrame that you are going to provide the source files in the stage directory.
The working directory of the <code class="xref py py-attr docutils literal"><span class="pre">prebuild_cmd</span></code> and <code class="xref py py-attr docutils literal"><span class="pre">postbuild_cmd</span></code> commands will be the stage directory of the test.</p>
<p>An alternative way to retrieve specifically a Git repository is to assign its URL directly to the <code class="xref py py-attr docutils literal"><span class="pre">sourcesdir</span></code> attribute:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">sourcesdir</span> <span class="o">=</span> <span class="s1">&#39;https://github.com/me/myrepo&#39;</span>
</pre></div>
</div>
<p>ReFrame will attempt to clone this repository inside the stage directory by executing <code class="docutils literal"><span class="pre">git</span> <span class="pre">clone</span> <span class="pre">&lt;repo&gt;</span> <span class="pre">.</span></code> and will then procede with the compilation as described above.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">ReFrame recognizes only URLs in the <code class="xref py py-attr docutils literal"><span class="pre">sourcesdir</span></code> attribute and requires passwordless access to the repository.
This means that the SCP-style repository specification will not be accepted.
You will have to specify it as URL using the <code class="docutils literal"><span class="pre">ssh://</span></code> protocol (see <a class="reference external" href="https://git-scm.com/docs/git-clone#_git_urls_a_id_urls_a">Git documentation page</a>).</p>
</div>
</div>
<div class="section" id="add-a-configuration-step-before-compiling-the-code">
<h3>Add a configuration step before compiling the code<a class="headerlink" href="#add-a-configuration-step-before-compiling-the-code" title="Permalink to this headline">¶</a></h3>
<p>It is often the case that a configuration step is needed before compiling a code with <code class="docutils literal"><span class="pre">make</span></code>.
To address this kind of projects, ReFrame aims to offer specific abstractions for “configure-make”-style build systems.
It supports <a class="reference external" href="https://cmake.org/">CMake-based</a> projects through the <a class="reference internal" href="reference.html#reframe.core.buildsystems.CMake" title="reframe.core.buildsystems.CMake"><code class="xref py py-class docutils literal"><span class="pre">CMake</span></code></a> build system, as well as <a class="reference external" href="https://www.gnu.org/software/automake/">Autotools-based</a> projects through the <a class="reference internal" href="reference.html#reframe.core.buildsystems.Autotools" title="reframe.core.buildsystems.Autotools"><code class="xref py py-class docutils literal"><span class="pre">Autotools</span></code></a> build system.</p>
<p>For other build systems, you can achieve the same effect using the <a class="reference internal" href="reference.html#reframe.core.buildsystems.Make" title="reframe.core.buildsystems.Make"><code class="xref py py-class docutils literal"><span class="pre">Make</span></code></a> build system and the <a class="reference internal" href="reference.html#reframe.core.pipeline.RegressionTest.prebuild_cmd" title="reframe.core.pipeline.RegressionTest.prebuild_cmd"><code class="xref py py-attr docutils literal"><span class="pre">prebuild_cmd</span></code></a> for performing the configuration step.
The following code snippet will configure a code with <code class="docutils literal"><span class="pre">./custom_configure</span></code> before invoking <code class="docutils literal"><span class="pre">make</span></code>:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">prebuild_cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;./custom_configure -with-mylib&#39;</span><span class="p">]</span>
<span class="bp">self</span><span class="o">.</span><span class="n">build_system</span> <span class="o">=</span> <span class="s1">&#39;Make&#39;</span>
<span class="bp">self</span><span class="o">.</span><span class="n">build_system</span><span class="o">.</span><span class="n">cppflags</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;-DHAVE_FOO&#39;</span><span class="p">]</span>
<span class="bp">self</span><span class="o">.</span><span class="n">build_system</span><span class="o">.</span><span class="n">flags_from_environ</span> <span class="o">=</span> <span class="bp">False</span>
</pre></div>
</div>
<p>The generated build script then will have the following lines:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>./custom_configure -with-mylib
make -j <span class="nv">CPPFLAGS</span><span class="o">=</span><span class="s1">&#39;-DHAVE_FOO&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="implementing-a-run-only-regression-test">
<h2>Implementing a Run-Only Regression Test<a class="headerlink" href="#implementing-a-run-only-regression-test" title="Permalink to this headline">¶</a></h2>
<p>There are cases when it is desirable to perform regression testing for an already built executable.
The following test uses the <code class="docutils literal"><span class="pre">echo</span></code> Bash shell command to print a random integer between specific lower and upper bounds.
Here is the full regression test (<code class="docutils literal"><span class="pre">tutorial/advanced/advanced_example2.py</span></code>):</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">reframe</span> <span class="k">as</span> <span class="nn">rfm</span>
<span class="kn">import</span> <span class="nn">reframe.utility.sanity</span> <span class="k">as</span> <span class="nn">sn</span>


<span class="nd">@rfm</span><span class="o">.</span><span class="n">simple_test</span>
<span class="k">class</span> <span class="nc">ExampleRunOnlyTest</span><span class="p">(</span><span class="n">rfm</span><span class="o">.</span><span class="n">RunOnlyRegressionTest</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">descr</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;ReFrame tutorial demonstrating the class&#39;</span>
                      <span class="s1">&#39;RunOnlyRegressionTest&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">valid_systems</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">valid_prog_environs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sourcesdir</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">lower</span> <span class="o">=</span> <span class="mi">90</span>
        <span class="n">upper</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executable</span> <span class="o">=</span> <span class="s1">&#39;echo &quot;Random: $((RANDOM%(</span><span class="si">{1}</span><span class="s1">+1-</span><span class="si">{0}</span><span class="s1">)+</span><span class="si">{0}</span><span class="s1">))&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sanity_patterns</span> <span class="o">=</span> <span class="n">sn</span><span class="o">.</span><span class="n">assert_bounded</span><span class="p">(</span><span class="n">sn</span><span class="o">.</span><span class="n">extractsingle</span><span class="p">(</span>
            <span class="sa">r</span><span class="s1">&#39;Random: (?P&lt;number&gt;\S+)&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="s1">&#39;number&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span>
            <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maintainers</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;put-your-name-here&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tags</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tutorial&#39;</span><span class="p">}</span>
</pre></div>
</div>
<p>There is nothing special for this test compared to those presented <a class="reference external" href="tutorial.html">earlier</a> except that it derives from the <a class="reference internal" href="reference.html#reframe.core.pipeline.RunOnlyRegressionTest" title="reframe.core.pipeline.RunOnlyRegressionTest"><code class="xref py py-class docutils literal"><span class="pre">RunOnlyRegressionTest</span></code></a> and that it does not contain any resources (<code class="docutils literal"><span class="pre">self.sourcesdir</span> <span class="pre">=</span> <span class="pre">None</span></code>).
Note that run-only regression tests may also have resources, as for instance a precompiled executable or some input data. The copying of these resources to the stage directory is performed at the beginning of the run phase.
For standard regression tests, this happens at the beginning of the compilation phase, instead.
Furthermore, in this particular test the <a class="reference internal" href="reference.html#reframe.core.pipeline.RegressionTest.executable" title="reframe.core.pipeline.RegressionTest.executable"><code class="xref py py-attr docutils literal"><span class="pre">executable</span></code></a> consists only of standard Bash shell commands.
For this reason, we can set <a class="reference internal" href="reference.html#reframe.core.pipeline.RegressionTest.sourcesdir" title="reframe.core.pipeline.RegressionTest.sourcesdir"><code class="xref py py-attr docutils literal"><span class="pre">sourcesdir</span></code></a> to <code class="docutils literal"><span class="pre">None</span></code> informing ReFrame that the test does not have any resources.</p>
</div>
<div class="section" id="implementing-a-compile-only-regression-test">
<h2>Implementing a Compile-Only Regression Test<a class="headerlink" href="#implementing-a-compile-only-regression-test" title="Permalink to this headline">¶</a></h2>
<p>ReFrame provides the option to write compile-only tests which consist only of a compilation phase without a specified executable.
This kind of tests must derive from the <a class="reference internal" href="reference.html#reframe.core.pipeline.CompileOnlyRegressionTest" title="reframe.core.pipeline.CompileOnlyRegressionTest"><code class="xref py py-class docutils literal"><span class="pre">CompileOnlyRegressionTest</span></code></a> class provided by the framework.
The following example (<code class="docutils literal"><span class="pre">tutorial/advanced/advanced_example3.py</span></code>) reuses the code of our first example in this section and checks that no warnings are issued by the compiler:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">reframe</span> <span class="k">as</span> <span class="nn">rfm</span>
<span class="kn">import</span> <span class="nn">reframe.utility.sanity</span> <span class="k">as</span> <span class="nn">sn</span>


<span class="nd">@rfm</span><span class="o">.</span><span class="n">simple_test</span>
<span class="k">class</span> <span class="nc">ExampleCompileOnlyTest</span><span class="p">(</span><span class="n">rfm</span><span class="o">.</span><span class="n">CompileOnlyRegressionTest</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">descr</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;ReFrame tutorial demonstrating the class&#39;</span>
                      <span class="s1">&#39;CompileOnlyRegressionTest&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">valid_systems</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">valid_prog_environs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sanity_patterns</span> <span class="o">=</span> <span class="n">sn</span><span class="o">.</span><span class="n">assert_not_found</span><span class="p">(</span><span class="s1">&#39;warning&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maintainers</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;put-your-name-here&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tags</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tutorial&#39;</span><span class="p">}</span>
</pre></div>
</div>
<p>The important thing to note here is that the standard output and standard error of the tests, accessible through the <a class="reference internal" href="reference.html#reframe.core.pipeline.RegressionTest.stdout" title="reframe.core.pipeline.RegressionTest.stdout"><code class="xref py py-attr docutils literal"><span class="pre">stdout</span></code></a> and <a class="reference internal" href="reference.html#reframe.core.pipeline.RegressionTest.stderr" title="reframe.core.pipeline.RegressionTest.stderr"><code class="xref py py-attr docutils literal"><span class="pre">stderr</span></code></a> attributes, are now the corresponding those of the compilation command.
So sanity checking can be done in exactly the same way as with a normal test.</p>
</div>
<div class="section" id="leveraging-environment-variables">
<h2>Leveraging Environment Variables<a class="headerlink" href="#leveraging-environment-variables" title="Permalink to this headline">¶</a></h2>
<p>We have already demonstrated in the <a class="reference external" href="tutorial.html">tutorial</a> that ReFrame allows you to load the required modules for regression tests and also set any needed environment variables. When setting environment variables for your test through the <a class="reference internal" href="reference.html#reframe.core.pipeline.RegressionTest.variables" title="reframe.core.pipeline.RegressionTest.variables"><code class="xref py py-attr docutils literal"><span class="pre">variables</span></code></a> attribute, you can assign them values of other, already defined, environment variables using the standard notation <code class="docutils literal"><span class="pre">$OTHER_VARIABLE</span></code> or <code class="docutils literal"><span class="pre">${OTHER_VARIABLE}</span></code>.
The following regression test (<code class="docutils literal"><span class="pre">tutorial/advanced/advanced_example4.py</span></code>) sets the <code class="docutils literal"><span class="pre">CUDA_HOME</span></code> environment variable to the value of the <code class="docutils literal"><span class="pre">CUDATOOLKIT_HOME</span></code> and then compiles and runs a simple program:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">reframe</span> <span class="k">as</span> <span class="nn">rfm</span>
<span class="kn">import</span> <span class="nn">reframe.utility.sanity</span> <span class="k">as</span> <span class="nn">sn</span>


<span class="nd">@rfm</span><span class="o">.</span><span class="n">simple_test</span>
<span class="k">class</span> <span class="nc">EnvironmentVariableTest</span><span class="p">(</span><span class="n">rfm</span><span class="o">.</span><span class="n">RegressionTest</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">descr</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;ReFrame tutorial demonstrating the use&#39;</span>
                      <span class="s1">&#39;of environment variables provided by loaded modules&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">valid_systems</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;daint:gpu&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">valid_prog_environs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modules</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;cudatoolkit&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">variables</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;CUDA_HOME&#39;</span><span class="p">:</span> <span class="s1">&#39;$CUDATOOLKIT_HOME&#39;</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executable</span> <span class="o">=</span> <span class="s1">&#39;./advanced_example4&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build_system</span> <span class="o">=</span> <span class="s1">&#39;Make&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build_system</span><span class="o">.</span><span class="n">makefile</span> <span class="o">=</span> <span class="s1">&#39;Makefile_example4&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sanity_patterns</span> <span class="o">=</span> <span class="n">sn</span><span class="o">.</span><span class="n">assert_found</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;SUCCESS&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maintainers</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;put-your-name-here&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tags</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tutorial&#39;</span><span class="p">}</span>
</pre></div>
</div>
<p>Before discussing this test in more detail, let’s first have a look in the source code and the Makefile of this example:</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp"></span>

<span class="cp">#ifndef CUDA_HOME</span>
<span class="cp">#   define CUDA_HOME &quot;&quot;</span>
<span class="cp">#endif</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">cuda_home_compile</span> <span class="o">=</span> <span class="n">CUDA_HOME</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">cuda_home_runtime</span> <span class="o">=</span> <span class="n">getenv</span><span class="p">(</span><span class="s">&quot;CUDA_HOME&quot;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">cuda_home_runtime</span> <span class="o">&amp;&amp;</span>
        <span class="n">strnlen</span><span class="p">(</span><span class="n">cuda_home_runtime</span><span class="p">,</span> <span class="mi">256</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
        <span class="n">strnlen</span><span class="p">(</span><span class="n">cuda_home_compile</span><span class="p">,</span> <span class="mi">256</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
        <span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">cuda_home_compile</span><span class="p">,</span> <span class="n">cuda_home_runtime</span><span class="p">,</span> <span class="mi">256</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;SUCCESS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;FAILURE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Compiled with CUDA_HOME=%s, ran with CUDA_HOME=%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
               <span class="n">cuda_home_compile</span><span class="p">,</span>
               <span class="n">cuda_home_runtime</span> <span class="o">?</span> <span class="nl">cuda_home_runtime</span> <span class="p">:</span> <span class="s">&quot;&lt;null&gt;&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This program is pretty basic, but enough to demonstrate the use of environment variables from ReFrame.
It simply compares the value of the <code class="docutils literal"><span class="pre">CUDA_HOME</span></code> macro with the value of the environment variable <code class="docutils literal"><span class="pre">CUDA_HOME</span></code> at runtime, printing <code class="docutils literal"><span class="pre">SUCCESS</span></code> if they are not empty and match.
The Makefile for this example compiles this source by simply setting <code class="docutils literal"><span class="pre">CUDA_HOME</span></code> to the value of the <code class="docutils literal"><span class="pre">CUDA_HOME</span></code> environment variable:</p>
<div class="highlight-makefile"><div class="highlight"><pre><span></span><span class="nv">EXECUTABLE</span> <span class="o">:=</span> advanced_example4

<span class="nv">CPPFLAGS</span> <span class="o">=</span> -DCUDA_HOME<span class="o">=</span><span class="se">\&quot;</span><span class="k">$(</span>CUDA_HOME<span class="k">)</span><span class="se">\&quot;</span>

<span class="nf">.SUFFIXES</span><span class="o">:</span> .<span class="n">o</span> .<span class="n">c</span>

<span class="nv">OBJS</span> <span class="o">:=</span> advanced_example4.o

<span class="nf">$(EXECUTABLE)</span><span class="o">:</span> <span class="k">$(</span><span class="nv">OBJS</span><span class="k">)</span>
	<span class="k">$(</span>CC<span class="k">)</span> <span class="k">$(</span>CFLAGS<span class="k">)</span> <span class="k">$(</span>LDFLAGS<span class="k">)</span> -o <span class="nv">$@</span> $^

<span class="nf">$(OBJS)</span><span class="o">:</span> <span class="n">advanced_example</span>4.<span class="n">c</span>
	<span class="k">$(</span>CC<span class="k">)</span> <span class="k">$(</span>CPPFLAGS<span class="k">)</span> <span class="k">$(</span>CFLAGS<span class="k">)</span> -c <span class="k">$(</span>LDFLAGS<span class="k">)</span> -o <span class="nv">$@</span> $^

<span class="nf">clean</span><span class="o">:</span>
	/bin/rm -f <span class="k">$(</span>OBJS<span class="k">)</span> <span class="k">$(</span>EXECUTABLE<span class="k">)</span>
</pre></div>
</div>
<p>Coming back now to the ReFrame regression test, the <code class="docutils literal"><span class="pre">CUDATOOLKIT_HOME</span></code> environment variable is defined by the <code class="docutils literal"><span class="pre">cudatoolkit</span></code> module.
If you try to run the test, you will see that it will succeed, meaning that the <code class="docutils literal"><span class="pre">CUDA_HOME</span></code> variable was set correctly both during the compilation and the runtime.</p>
<p>When ReFrame <a class="reference external" href="pipeline.html#the-setup-phase">sets up</a> a test, it first loads its required modules and then sets the required environment variables expanding their values.
This has the result that <code class="docutils literal"><span class="pre">CUDA_HOME</span></code> takes the correct value in our example at the compilation time.</p>
<p>At runtime, ReFrame will generate the following instructions in the shell script associated with this test:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>module load cudatoolkit
<span class="nb">export</span> <span class="nv">CUDA_HOME</span><span class="o">=</span><span class="nv">$CUDATOOLKIT_HOME</span>
</pre></div>
</div>
<p>This ensures that the environment of the test is also set correctly at runtime.</p>
<p>Finally, as already mentioned <a class="reference external" href="#working-with-makefiles">previously</a>, since the name of the makefile is not one of the standard ones, it must be set explicitly in the build system:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">build_system</span><span class="o">.</span><span class="n">makefile</span> <span class="o">=</span> <span class="s1">&#39;Makefile_example4&#39;</span>
</pre></div>
</div>
</div>
<div class="section" id="setting-a-time-limit-for-regression-tests">
<h2>Setting a Time Limit for Regression Tests<a class="headerlink" href="#setting-a-time-limit-for-regression-tests" title="Permalink to this headline">¶</a></h2>
<p>ReFrame gives you the option to limit the execution time of regression tests.
The following example (<code class="docutils literal"><span class="pre">tutorial/advanced/advanced_example5.py</span></code>) demonstrates how you can achieve this by limiting the execution time of a test that tries to sleep 100 seconds:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">reframe</span> <span class="k">as</span> <span class="nn">rfm</span>
<span class="kn">import</span> <span class="nn">reframe.utility.sanity</span> <span class="k">as</span> <span class="nn">sn</span>


<span class="nd">@rfm</span><span class="o">.</span><span class="n">simple_test</span>
<span class="k">class</span> <span class="nc">TimeLimitTest</span><span class="p">(</span><span class="n">rfm</span><span class="o">.</span><span class="n">RunOnlyRegressionTest</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">descr</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;ReFrame tutorial demonstrating the use&#39;</span>
                      <span class="s1">&#39;of a user-defined time limit&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">valid_systems</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;daint:gpu&#39;</span><span class="p">,</span> <span class="s1">&#39;daint:mc&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">valid_prog_environs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_limit</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executable</span> <span class="o">=</span> <span class="s1">&#39;sleep&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executable_opts</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;100&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sanity_patterns</span> <span class="o">=</span> <span class="n">sn</span><span class="o">.</span><span class="n">assert_found</span><span class="p">(</span>
            <span class="sa">r</span><span class="s1">&#39;CANCELLED.*DUE TO TIME LIMIT&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maintainers</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;put-your-name-here&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tags</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tutorial&#39;</span><span class="p">}</span>
</pre></div>
</div>
<p>The important bit here is the following line that sets the time limit for the test to one minute:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">time_limit</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<p>The <a class="reference internal" href="reference.html#reframe.core.pipeline.RegressionTest.time_limit" title="reframe.core.pipeline.RegressionTest.time_limit"><code class="xref py py-attr docutils literal"><span class="pre">time_limit</span></code></a> attribute is a three-tuple in the form <code class="docutils literal"><span class="pre">(HOURS,</span> <span class="pre">MINUTES,</span> <span class="pre">SECONDS)</span></code>.
Time limits are implemented for all the scheduler backends.</p>
<p>The sanity condition for this test verifies that associated job has been canceled due to the time limit (note that this message is SLURM-specific).</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">sanity_patterns</span> <span class="o">=</span> <span class="n">sn</span><span class="o">.</span><span class="n">assert_found</span><span class="p">(</span>
    <span class="sa">r</span><span class="s1">&#39;CANCELLED.*DUE TO TIME LIMIT&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="applying-a-sanity-function-iteratively">
<h2>Applying a sanity function iteratively<a class="headerlink" href="#applying-a-sanity-function-iteratively" title="Permalink to this headline">¶</a></h2>
<p>It is often the case that a common sanity pattern has to be applied many times.
In this example we will demonstrate how the above situation can be easily tackled using the <a class="reference internal" href="sanity_functions_reference.html#module-reframe.utility.sanity" title="reframe.utility.sanity"><code class="xref py py-mod docutils literal"><span class="pre">sanity</span></code></a> functions offered by ReFrame.
Specifically, we would like to execute the following shell script and check that its output is correct:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env bash</span>

<span class="k">if</span> <span class="o">[</span> -z <span class="nv">$LOWER</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nb">export</span> <span class="nv">LOWER</span><span class="o">=</span><span class="m">90</span>
<span class="k">fi</span>

<span class="k">if</span> <span class="o">[</span> -z <span class="nv">$UPPER</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nb">export</span> <span class="nv">UPPER</span><span class="o">=</span><span class="m">100</span>
<span class="k">fi</span>

<span class="k">for</span> i in <span class="o">{</span><span class="m">1</span>..100<span class="o">}</span><span class="p">;</span> <span class="k">do</span>
    <span class="nb">echo</span> Random: <span class="k">$((</span>RANDOM%<span class="o">(</span><span class="nv">$UPPER</span><span class="o">+</span><span class="m">1</span><span class="o">-</span><span class="nv">$LOWER</span><span class="o">)+</span><span class="nv">$LOWER</span><span class="k">))</span>
<span class="k">done</span>
</pre></div>
</div>
<p>The above script simply prints 100 random integers between the limits given by the variables <code class="docutils literal"><span class="pre">LOWER</span></code> and <code class="docutils literal"><span class="pre">UPPER</span></code>.
In the corresponding regression test we want to check that all the random numbers printed lie between 90 and 100 ensuring that the script executed correctly.
Hence, a common sanity check has to be applied to all the printed random numbers.
In ReFrame this can achieved by the use of <a class="reference internal" href="sanity_functions_reference.html#reframe.utility.sanity.map" title="reframe.utility.sanity.map"><code class="xref py py-func docutils literal"><span class="pre">map</span></code></a> sanity function accepting a function and an iterable as arguments.
Through <a class="reference internal" href="sanity_functions_reference.html#reframe.utility.sanity.map" title="reframe.utility.sanity.map"><code class="xref py py-func docutils literal"><span class="pre">map</span></code></a> the given function will be applied to all the members of the iterable object.
Note that since <a class="reference internal" href="sanity_functions_reference.html#reframe.utility.sanity.map" title="reframe.utility.sanity.map"><code class="xref py py-func docutils literal"><span class="pre">map</span></code></a> is a sanity function, its execution will be deferred.
The contents of the ReFrame regression test contained in <code class="docutils literal"><span class="pre">advanced_example6.py</span></code> are the following:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">reframe</span> <span class="k">as</span> <span class="nn">rfm</span>
<span class="kn">import</span> <span class="nn">reframe.utility.sanity</span> <span class="k">as</span> <span class="nn">sn</span>


<span class="nd">@rfm</span><span class="o">.</span><span class="n">simple_test</span>
<span class="k">class</span> <span class="nc">DeferredIterationTest</span><span class="p">(</span><span class="n">rfm</span><span class="o">.</span><span class="n">RunOnlyRegressionTest</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">descr</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;ReFrame tutorial demonstrating the use of deferred &#39;</span>
                      <span class="s1">&#39;iteration via the `map` sanity function.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">valid_systems</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">valid_prog_environs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executable</span> <span class="o">=</span> <span class="s1">&#39;./random_numbers.sh&#39;</span>
        <span class="n">numbers</span> <span class="o">=</span> <span class="n">sn</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span>
            <span class="sa">r</span><span class="s1">&#39;Random: (?P&lt;number&gt;\S+)&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="s1">&#39;number&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sanity_patterns</span> <span class="o">=</span> <span class="n">sn</span><span class="o">.</span><span class="n">and_</span><span class="p">(</span>
            <span class="n">sn</span><span class="o">.</span><span class="n">assert_eq</span><span class="p">(</span><span class="n">sn</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">numbers</span><span class="p">),</span> <span class="mi">100</span><span class="p">),</span>
            <span class="n">sn</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">sn</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">sn</span><span class="o">.</span><span class="n">assert_bounded</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span> <span class="n">numbers</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maintainers</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;put-your-name-here&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tags</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tutorial&#39;</span><span class="p">}</span>
</pre></div>
</div>
<p>First the random numbers are extracted through the <a class="reference internal" href="sanity_functions_reference.html#reframe.utility.sanity.extractall" title="reframe.utility.sanity.extractall"><code class="xref py py-func docutils literal"><span class="pre">extractall</span></code></a> function as follows:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">numbers</span> <span class="o">=</span> <span class="n">sn</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span>
    <span class="sa">r</span><span class="s1">&#39;Random: (?P&lt;number&gt;\S+)&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="s1">&#39;number&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">numbers</span></code> variable is a deferred iterable, which upon evaluation will return all the extracted numbers.
In order to check that the extracted numbers lie within the specified limits, we make use of the <a class="reference internal" href="sanity_functions_reference.html#reframe.utility.sanity.map" title="reframe.utility.sanity.map"><code class="xref py py-func docutils literal"><span class="pre">map</span></code></a> sanity function, which will apply the <a class="reference internal" href="sanity_functions_reference.html#reframe.utility.sanity.assert_bounded" title="reframe.utility.sanity.assert_bounded"><code class="xref py py-func docutils literal"><span class="pre">assert_bounded</span></code></a> to all the elements of <code class="docutils literal"><span class="pre">numbers</span></code>.
Additionally, our requirement is that all the numbers satisfy the above constraint and we therefore use <a class="reference internal" href="sanity_functions_reference.html#reframe.utility.sanity.all" title="reframe.utility.sanity.all"><code class="xref py py-func docutils literal"><span class="pre">all</span></code></a>.</p>
<p>There is still a small complication that needs to be addressed.
The <a class="reference internal" href="sanity_functions_reference.html#reframe.utility.sanity.all" title="reframe.utility.sanity.all"><code class="xref py py-func docutils literal"><span class="pre">all</span></code></a> function returns <code class="xref py py-class docutils literal"><span class="pre">True</span></code> for empty iterables, which is not what we want.
So we must ensure that all the numbers are extracted as well.
To achieve this, we make use of <a class="reference internal" href="sanity_functions_reference.html#reframe.utility.sanity.count" title="reframe.utility.sanity.count"><code class="xref py py-func docutils literal"><span class="pre">count</span></code></a> to get the number of elements contained in <code class="docutils literal"><span class="pre">numbers</span></code> combined with <a class="reference internal" href="sanity_functions_reference.html#reframe.utility.sanity.assert_eq" title="reframe.utility.sanity.assert_eq"><code class="xref py py-func docutils literal"><span class="pre">assert_eq</span></code></a> to check that the number is indeed 100.
Finally, both of the above conditions have to be satisfied for the program execution to be considered successful, hence the use of the <a class="reference internal" href="sanity_functions_reference.html#reframe.utility.sanity.and_" title="reframe.utility.sanity.and_"><code class="xref py py-func docutils literal"><span class="pre">and_</span></code></a> function.
Note that the <code class="docutils literal"><span class="pre">and</span></code> operator is not deferrable and will trigger the evaluation of any deferrable argument passed to it.</p>
<p>The full syntax for the <code class="xref py py-attr docutils literal"><span class="pre">sanity_patterns</span></code> is the following:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">sanity_patterns</span> <span class="o">=</span> <span class="n">sn</span><span class="o">.</span><span class="n">and_</span><span class="p">(</span>
    <span class="n">sn</span><span class="o">.</span><span class="n">assert_eq</span><span class="p">(</span><span class="n">sn</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">numbers</span><span class="p">),</span> <span class="mi">100</span><span class="p">),</span>
    <span class="n">sn</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">sn</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">sn</span><span class="o">.</span><span class="n">assert_bounded</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span> <span class="n">numbers</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="section" id="customizing-the-generated-job-script">
<h2>Customizing the Generated Job Script<a class="headerlink" href="#customizing-the-generated-job-script" title="Permalink to this headline">¶</a></h2>
<p>It is often the case that you must run some commands before and/or after the parallel launch of your executable.
This can be easily achieved by using the <a class="reference internal" href="reference.html#reframe.core.pipeline.RegressionTest.pre_run" title="reframe.core.pipeline.RegressionTest.pre_run"><code class="xref py py-attr docutils literal"><span class="pre">pre_run</span></code></a> and <a class="reference internal" href="reference.html#reframe.core.pipeline.RegressionTest.post_run" title="reframe.core.pipeline.RegressionTest.post_run"><code class="xref py py-attr docutils literal"><span class="pre">post_run</span></code></a> attributes of <code class="xref py py-class docutils literal"><span class="pre">RegressionTest</span></code>.</p>
<p>The following example is a slightly modified version of the previous one.
The lower and upper limits for the random numbers are now set inside a helper shell script in <code class="docutils literal"><span class="pre">scripts/limits.sh</span></code> and we want also to print the word <code class="docutils literal"><span class="pre">FINISHED</span></code> after our executable has finished.
In order to achieve this, we need to source the helper script just before launching the executable and <code class="docutils literal"><span class="pre">echo</span></code> the desired message just after it finishes.
Here is the test file:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">reframe</span> <span class="k">as</span> <span class="nn">rfm</span>
<span class="kn">import</span> <span class="nn">reframe.utility.sanity</span> <span class="k">as</span> <span class="nn">sn</span>


<span class="nd">@rfm</span><span class="o">.</span><span class="n">simple_test</span>
<span class="k">class</span> <span class="nc">PrerunDemoTest</span><span class="p">(</span><span class="n">rfm</span><span class="o">.</span><span class="n">RunOnlyRegressionTest</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">descr</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;ReFrame tutorial demonstrating the use of &#39;</span>
                      <span class="s1">&#39;pre- and post-run commands&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">valid_systems</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">valid_prog_environs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pre_run</span>  <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;source scripts/limits.sh&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">post_run</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;echo FINISHED&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executable</span> <span class="o">=</span> <span class="s1">&#39;./random_numbers.sh&#39;</span>
        <span class="n">numbers</span> <span class="o">=</span> <span class="n">sn</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span>
            <span class="sa">r</span><span class="s1">&#39;Random: (?P&lt;number&gt;\S+)&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="s1">&#39;number&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sanity_patterns</span> <span class="o">=</span> <span class="n">sn</span><span class="o">.</span><span class="n">all</span><span class="p">([</span>
            <span class="n">sn</span><span class="o">.</span><span class="n">assert_eq</span><span class="p">(</span><span class="n">sn</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">numbers</span><span class="p">),</span> <span class="mi">100</span><span class="p">),</span>
            <span class="n">sn</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">sn</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">sn</span><span class="o">.</span><span class="n">assert_bounded</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">80</span><span class="p">),</span> <span class="n">numbers</span><span class="p">)),</span>
            <span class="n">sn</span><span class="o">.</span><span class="n">assert_found</span><span class="p">(</span><span class="s1">&#39;FINISHED&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
        <span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maintainers</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;put-your-name-here&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tags</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tutorial&#39;</span><span class="p">}</span>
</pre></div>
</div>
<p>Notice the use of the <code class="xref py py-attr docutils literal"><span class="pre">pre_run</span></code> and <code class="xref py py-attr docutils literal"><span class="pre">post_run</span></code> attributes.
These are list of shell commands that are emitted verbatim in the job script.
The generated job script for this example is the following:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash -l</span>
<span class="c1">#SBATCH --job-name=&quot;prerun_demo_check_daint_gpu_PrgEnv-gnu&quot;</span>
<span class="c1">#SBATCH --time=0:10:0</span>
<span class="c1">#SBATCH --ntasks=1</span>
<span class="c1">#SBATCH --output=/path/to/stage/gpu/prerun_demo_check/PrgEnv-gnu/prerun_demo_check.out</span>
<span class="c1">#SBATCH --error=/path/to/stage/gpu/prerun_demo_check/PrgEnv-gnu/prerun_demo_check.err</span>
<span class="c1">#SBATCH --constraint=gpu</span>
module load daint-gpu
module unload PrgEnv-cray
module load PrgEnv-gnu
<span class="nb">source</span> scripts/limits.sh
srun ./random_numbers.sh
<span class="nb">echo</span> FINISHED
</pre></div>
</div>
<p>ReFrame generates the job shell script using the following pattern:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash -l</span>
<span class="o">{</span>job_scheduler_preamble<span class="o">}</span>
<span class="o">{</span>test_environment<span class="o">}</span>
<span class="o">{</span>pre_run<span class="o">}</span>
<span class="o">{</span>parallel_launcher<span class="o">}</span> <span class="o">{</span>executable<span class="o">}</span> <span class="o">{</span>executable_opts<span class="o">}</span>
<span class="o">{</span>post_run<span class="o">}</span>
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">job_scheduler_preamble</span></code> contains the directives that control the job allocation.
The <code class="docutils literal"><span class="pre">test_environment</span></code> are the necessary commands for setting up the environment of the test.
This is the place where the modules and environment variables specified in <a class="reference internal" href="reference.html#reframe.core.pipeline.RegressionTest.modules" title="reframe.core.pipeline.RegressionTest.modules"><code class="xref py py-attr docutils literal"><span class="pre">modules</span></code></a> and <a class="reference internal" href="reference.html#reframe.core.pipeline.RegressionTest.variables" title="reframe.core.pipeline.RegressionTest.variables"><code class="xref py py-attr docutils literal"><span class="pre">variables</span></code></a> attributes are emitted.
Then the commands specified in <code class="xref py py-attr docutils literal"><span class="pre">pre_run</span></code> follow, while those specified in the <code class="xref py py-attr docutils literal"><span class="pre">post_run</span></code> come after the launch of the parallel job.
The parallel launch itself consists of three parts:</p>
<ol class="arabic simple">
<li>The parallel launcher program (e.g., <code class="docutils literal"><span class="pre">srun</span></code>, <code class="docutils literal"><span class="pre">mpirun</span></code> etc.) with its options,</li>
<li>the regression test executable as specified in the <a class="reference internal" href="reference.html#reframe.core.pipeline.RegressionTest.executable" title="reframe.core.pipeline.RegressionTest.executable"><code class="xref py py-attr docutils literal"><span class="pre">executable</span></code></a> attribute and</li>
<li>the options to be passed to the executable as specified in the <a class="reference internal" href="reference.html#reframe.core.pipeline.RegressionTest.executable_opts" title="reframe.core.pipeline.RegressionTest.executable_opts"><code class="xref py py-attr docutils literal"><span class="pre">executable_opts</span></code></a> attribute.</li>
</ol>
<p>A key thing to note about the generated job script is that ReFrame submits it from the stage directory of the test, so that all relative paths are resolved against it.</p>
</div>
<div class="section" id="working-with-parameterized-tests">
<h2>Working with parameterized tests<a class="headerlink" href="#working-with-parameterized-tests" title="Permalink to this headline">¶</a></h2>
<div class="versionadded">
<p><span class="versionmodified">New in version 2.13.</span></p>
</div>
<p>We have seen already in the <a class="reference external" href="tutorial.html#combining-it-all-together">basic tutorial</a> how we could better organize the tests so as to avoid code duplication by using test class hierarchies.
An alternative technique, which could also be used in parallel with the class hierarchies, is to use <cite>parameterized tests</cite>.
The following is a test that takes a <code class="docutils literal"><span class="pre">variant</span></code> parameter, which controls which variant of the code will be used.
Depending on that value, the test is set up differently:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">reframe</span> <span class="k">as</span> <span class="nn">rfm</span>
<span class="kn">import</span> <span class="nn">reframe.utility.sanity</span> <span class="k">as</span> <span class="nn">sn</span>


<span class="nd">@rfm</span><span class="o">.</span><span class="n">parameterized_test</span><span class="p">([</span><span class="s1">&#39;MPI&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;OpenMP&#39;</span><span class="p">])</span>
<span class="k">class</span> <span class="nc">MatrixVectorTest</span><span class="p">(</span><span class="n">rfm</span><span class="o">.</span><span class="n">RegressionTest</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variant</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">descr</span> <span class="o">=</span> <span class="s1">&#39;Matrix-vector multiplication test (</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="n">variant</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">valid_systems</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;daint:gpu&#39;</span><span class="p">,</span> <span class="s1">&#39;daint:mc&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">valid_prog_environs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;PrgEnv-cray&#39;</span><span class="p">,</span> <span class="s1">&#39;PrgEnv-gnu&#39;</span><span class="p">,</span>
                                    <span class="s1">&#39;PrgEnv-intel&#39;</span><span class="p">,</span> <span class="s1">&#39;PrgEnv-pgi&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build_system</span> <span class="o">=</span> <span class="s1">&#39;SingleSource&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prgenv_flags</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;PrgEnv-cray&#39;</span><span class="p">:</span>  <span class="p">[</span><span class="s1">&#39;-homp&#39;</span><span class="p">],</span>
            <span class="s1">&#39;PrgEnv-gnu&#39;</span><span class="p">:</span>   <span class="p">[</span><span class="s1">&#39;-fopenmp&#39;</span><span class="p">],</span>
            <span class="s1">&#39;PrgEnv-intel&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;-openmp&#39;</span><span class="p">],</span>
            <span class="s1">&#39;PrgEnv-pgi&#39;</span><span class="p">:</span>   <span class="p">[</span><span class="s1">&#39;-mp&#39;</span><span class="p">]</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="n">variant</span> <span class="o">==</span> <span class="s1">&#39;MPI&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_tasks</span> <span class="o">=</span> <span class="mi">8</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_tasks_per_node</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_cpus_per_task</span> <span class="o">=</span> <span class="mi">4</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sourcepath</span> <span class="o">=</span> <span class="s1">&#39;example_matrix_vector_multiplication_mpi_openmp.c&#39;</span>
        <span class="k">elif</span> <span class="n">variant</span> <span class="o">==</span> <span class="s1">&#39;OpenMP&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sourcepath</span> <span class="o">=</span> <span class="s1">&#39;example_matrix_vector_multiplication_openmp.c&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_cpus_per_task</span> <span class="o">=</span> <span class="mi">4</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">variables</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;OMP_NUM_THREADS&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_cpus_per_task</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="n">matrix_dim</span> <span class="o">=</span> <span class="mi">1024</span>
        <span class="n">iterations</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executable_opts</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">matrix_dim</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">iterations</span><span class="p">)]</span>

        <span class="n">expected_norm</span> <span class="o">=</span> <span class="n">matrix_dim</span>
        <span class="n">found_norm</span> <span class="o">=</span> <span class="n">sn</span><span class="o">.</span><span class="n">extractsingle</span><span class="p">(</span>
            <span class="sa">r</span><span class="s1">&#39;The L2 norm of the resulting vector is:\s+(?P&lt;norm&gt;\S+)&#39;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="s1">&#39;norm&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sanity_patterns</span> <span class="o">=</span> <span class="n">sn</span><span class="o">.</span><span class="n">all</span><span class="p">([</span>
            <span class="n">sn</span><span class="o">.</span><span class="n">assert_found</span><span class="p">(</span>
                <span class="sa">r</span><span class="s1">&#39;time for single matrix vector multiplication&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">),</span>
            <span class="n">sn</span><span class="o">.</span><span class="n">assert_lt</span><span class="p">(</span><span class="n">sn</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">expected_norm</span> <span class="o">-</span> <span class="n">found_norm</span><span class="p">),</span> <span class="mf">1.0e-6</span><span class="p">)</span>
        <span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maintainers</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;you-can-type-your-email-here&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tags</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tutorial&#39;</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">partition</span><span class="p">,</span> <span class="n">environ</span><span class="p">,</span> <span class="o">**</span><span class="n">job_opts</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prgenv_flags</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">build_system</span><span class="o">.</span><span class="n">cflags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prgenv_flags</span><span class="p">[</span><span class="n">environ</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">partition</span><span class="p">,</span> <span class="n">environ</span><span class="p">,</span> <span class="o">**</span><span class="n">job_opts</span><span class="p">)</span>
</pre></div>
</div>
<p>If you have already gone through the <a class="reference external" href="tutorial.html">tutorial</a>, this test can be easily understood.
The new bit here is the <code class="docutils literal"><span class="pre">&#64;parameterized_test</span></code> decorator of the <code class="docutils literal"><span class="pre">MatrixVectorTest</span></code> class.
This decorator takes an arbitrary number of arguments, which are either of a sequence type (i.e., list, tuple etc.) or of a mapping type (i.e., dictionary).
Each of the decorator’s arguments corresponds to the constructor arguments of the decorated test that will be used to instantiate it.
In the example shown, the test will be instantiated twice, once passing <code class="docutils literal"><span class="pre">variant</span></code> as <code class="docutils literal"><span class="pre">MPI</span></code> and a second time with <code class="docutils literal"><span class="pre">variant</span></code> passed as <code class="docutils literal"><span class="pre">OpenMP</span></code>.
The framework will try to generate unique names for the generated tests by stringifying the arguments passed to the test’s constructor:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>Command line: ./bin/reframe -C tutorial/config/settings.py -c tutorial/advanced/advanced_example8.py -l
Reframe version: 2.13-dev0
Launched by user: XXX
Launched on host: daint101
Reframe paths
=============
    Check prefix      :
    Check search path : &#39;tutorial/advanced/advanced_example8.py&#39;
    Stage dir prefix  : current/working/dir/reframe/stage/
    Output dir prefix : current/working/dir/reframe/output/
    Logging dir       : current/working/dir/reframe/logs
List of matched checks
======================
  * MatrixVectorTest_MPI (Matrix-vector multiplication test (MPI))
        tags: [tutorial], maintainers: [you-can-type-your-email-here]
  * MatrixVectorTest_OpenMP (Matrix-vector multiplication test (OpenMP))
        tags: [tutorial], maintainers: [you-can-type-your-email-here]
Found 2 check(s).
</pre></div>
</div>
<p>There are a couple of different ways that we could have used the <code class="docutils literal"><span class="pre">&#64;parameterized_test</span></code> decorator.
One is to use dictionaries for specifying the instantiations of our test class.
The dictionaries will be converted to keyword arguments and passed to the constructor of the test class:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="nd">@rfm.parameterized_test</span><span class="p">({</span><span class="s1">&#39;variant&#39;</span><span class="p">:</span> <span class="s1">&#39;MPI&#39;</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;variant&#39;</span><span class="p">:</span> <span class="s1">&#39;OpenMP&#39;</span><span class="p">})</span>
</pre></div>
</div>
<p>Another way, which is quite useful if you want to generate lots of different tests at the same time, is to use either <a class="reference external" href="https://docs.python.org/3.6/tutorial/datastructures.html#list-comprehensions">list comprehensions</a> or <a class="reference external" href="https://www.python.org/dev/peps/pep-0289/">generator expressions</a> for specifying the different test instantiations:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="nd">@rfm.parameterized_test</span><span class="p">(</span><span class="o">*</span><span class="p">([</span><span class="n">variant</span><span class="p">]</span> <span class="k">for</span> <span class="n">variant</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;MPI&#39;</span><span class="p">,</span> <span class="s1">&#39;OpenMP&#39;</span><span class="p">]))</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">In versions of the framework prior to 2.13, this could be achieved by explicitly instantiating your tests inside the <code class="docutils literal"><span class="pre">_get_checks()</span></code> method.</p>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">Combining parameterized tests and test class hierarchies can offer you a very flexible way for generating multiple related tests at once keeping at the same time the maintenance cost low.
We use this technique extensively in our tests.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          
<footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="deferrables.html" class="btn btn-neutral float-right" title="Understanding the Mechanism of Sanity Functions" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="tutorial.html" class="btn btn-neutral" title="ReFrame Tutorial" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017-2018, CSCS.
    </p>

    <style type="text/css">
      .cscs_group:after {
        content:"";
        display: table;
        clear: both;
      }
      .cscs_left {
        float: left;
        width: 50%;
      }
      .cscs_right {
        float: right;
        width: 50%;
    }
      @media screen and (max-width: 768px) {
        .cscs_left,
        .cscs_right {
          float: none;
          width: auto;
          margin-bottom: 20px;
        }
      }
    </style>
    <p>
      <div class="cscs_group">
        <div class="cscs_left">
          <strong>CSCS</strong><br />
          <strong>Swiss National Supercomputing Centre</strong><br />
          Via Trevano 131<br />
          6900 Lugano<br />
          Switzerland
        </div>
        <div  class="cscs_right" style="margin-left: auto; margin-right: auto;">
          <a href="http://www.cscs.ch" target="_blank">
            <img id="cscs-cscs-logo" src="_static/img/logo_cscs.png" style="background-color: transparent; margin-top: 5px;">
          </a>
        </div>
      </div>
    </p>
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.

  </div>

</footer>
        </div>
      </div>

    </section>

  </div>
  
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
        <span class="fa fa-book"> Other Versions</span>
        v: master
        <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
        <dl>
            <dt>Tags</dt>
            <dd><a href="v2.10/advanced.html">v2.10</a></dd>
            <dd><a href="v2.11/advanced.html">v2.11</a></dd>
            <dd><a href="v2.12/advanced.html">v2.12</a></dd>
            <dd><a href="v2.13/advanced.html">v2.13</a></dd>
            <dd><a href="v2.14/advanced.html">v2.14</a></dd>
            <dd><a href="v2.7/advanced.html">v2.7</a></dd>
            <dd><a href="v2.8/advanced.html">v2.8</a></dd>
            <dd><a href="v2.9/advanced.html">v2.9</a></dd>
        </dl>
        <dl>
            <dt>Branches</dt>
            <dd><a href="master/advanced.html">master</a></dd>
        </dl>
    </div>
</div>


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'2.14',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>

  

  <script type="text/javascript" src="_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>